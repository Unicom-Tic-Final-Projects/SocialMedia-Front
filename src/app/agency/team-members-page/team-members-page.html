<section class="flex flex-col gap-8">
  <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
    <div class="space-y-2">
      <h1 class="text-3xl font-semibold text-slate-900">Team Members</h1>
      <p class="text-sm text-slate-500 md:text-base">
        Manage your agency team members. Add editors, admins, and other roles to collaborate on client work.
      </p>
    </div>
    <button 
      (click)="openCreateModal()"
      class="inline-flex items-center gap-2 rounded-xl bg-primary-500 px-5 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-primary-600">
      <i class="fa-solid fa-user-plus"></i>
      Add Team Member
    </button>
  </header>

  @if (successMessage()) {
    <div class="rounded-xl border border-green-200 bg-green-50 px-4 py-3 text-green-700 text-sm">
      <i class="fa-solid fa-check-circle mr-2"></i>
      {{ successMessage() }}
    </div>
  }

  @if (error() || errorMessage()) {
    <div class="rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-red-600 text-sm">
      <i class="fa-solid fa-exclamation-circle mr-2"></i>
      {{ error() || errorMessage() }}
    </div>
  }

  <div class="overflow-hidden rounded-3xl border border-slate-200 bg-white shadow-sm">
    @if (loading()) {
      <div class="px-6 py-12 text-center text-sm text-slate-500">
        <i class="fa-solid fa-circle-notch animate-spin text-2xl mb-2 text-primary-500"></i>
        <p>Loading team members...</p>
      </div>
    } @else if (teamMembers().length === 0) {
      <div class="px-6 py-10 text-center text-sm font-semibold text-slate-400">
        <i class="fa-solid fa-users-slash text-3xl mb-3 text-slate-300"></i>
        <p>No team members yet. Add your first team member to get started.</p>
      </div>
    } @else {
      <table class="min-w-full divide-y divide-slate-200">
        <thead class="bg-slate-50 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">
          <tr>
            <th class="px-6 py-4">Email</th>
            <th class="px-6 py-4">Role</th>
            <th class="px-6 py-4">Joined</th>
            <th class="px-6 py-4 text-right">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100 text-sm">
          @for (member of teamMembers(); track trackMemberById($index, member)) {
            <tr class="hover:bg-slate-50/70 transition">
              <td class="px-6 py-4 font-medium text-slate-900">{{ member.email }}</td>
              <td class="px-6 py-4">
                <span
                  class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold"
                  [ngClass]="getRoleBadgeClass(member.role)">
                  {{ member.role }}
                </span>
              </td>
              <td class="px-6 py-4 text-slate-600">
                {{ member.createdAt | date:'short' }}
              </td>
              <td class="px-6 py-4 text-right">
                <div class="flex items-center justify-end gap-2">
                  <button
                    (click)="openEditModal(member)"
                    class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-slate-700 bg-slate-100 rounded-lg hover:bg-slate-200 transition"
                    title="Edit team member">
                    <i class="fa-solid fa-edit"></i>
                    Edit
                  </button>
                  <button
                    (click)="deleteTeamMember(member)"
                    class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-red-600 bg-red-50 rounded-lg hover:bg-red-100 transition"
                    title="Remove team member">
                    <i class="fa-solid fa-trash"></i>
                    Remove
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    }
  </div>

  <!-- Team Member Creation Modal -->
  @if (showModal()) {
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" (click)="closeModal()">
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4" (click)="$event.stopPropagation()">
        <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between">
          <h2 class="text-xl font-semibold text-slate-900">
            {{ isEditing() ? 'Edit Team Member' : 'Add Team Member' }}
          </h2>
          <button
            (click)="closeModal()"
            class="text-slate-400 hover:text-slate-600 transition">
            <i class="fa-solid fa-times text-xl"></i>
          </button>
        </div>

        <form [formGroup]="teamMemberForm" (ngSubmit)="saveTeamMember()" class="p-6 space-y-5">
          @if (errorMessage()) {
            <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-red-600 text-sm">
              <i class="fa-solid fa-exclamation-circle mr-2"></i>
              {{ errorMessage() }}
            </div>
          }

          <div>
            <label for="email" class="block text-sm font-medium text-slate-700 mb-2">
              Email Address <span class="text-red-500">*</span>
            </label>
            <input
              id="email"
              type="email"
              formControlName="email"
              class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              placeholder="team.member@example.com">
            @if (teamMemberForm.controls.email.invalid && teamMemberForm.controls.email.touched) {
              <p class="mt-1 text-sm text-red-500">
                @if (teamMemberForm.controls.email.errors?.['required']) {
                  Email is required.
                } @else if (teamMemberForm.controls.email.errors?.['email']) {
                  Please enter a valid email address.
                }
              </p>
            }
          </div>

          <div>
            <label for="role" class="block text-sm font-medium text-slate-700 mb-2">
              Role <span class="text-red-500">*</span>
            </label>
            <select
              id="role"
              formControlName="role"
              class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
              @for (role of roles; track role.value) {
                <option [value]="role.value">{{ role.label }}</option>
              }
            </select>
            @if (teamMemberForm.controls.role.invalid && teamMemberForm.controls.role.touched) {
              <p class="mt-1 text-sm text-red-500">Role is required.</p>
            }
          </div>

          @if (!isEditing()) {
            <div>
              <label for="password" class="block text-sm font-medium text-slate-700 mb-2">
                Password <span class="text-red-500">*</span>
              </label>
              <input
                id="password"
                type="password"
                formControlName="password"
                class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                placeholder="Minimum 6 characters">
              @if (teamMemberForm.controls.password.invalid && teamMemberForm.controls.password.touched) {
                <p class="mt-1 text-sm text-red-500">
                  @if (teamMemberForm.controls.password.errors?.['required']) {
                    Password is required.
                  } @else if (teamMemberForm.controls.password.errors?.['minlength']) {
                    Password must be at least 6 characters.
                  }
                </p>
              }
            </div>

            <div>
              <label for="confirmPassword" class="block text-sm font-medium text-slate-700 mb-2">
                Confirm Password <span class="text-red-500">*</span>
              </label>
              <input
                id="confirmPassword"
                type="password"
                formControlName="confirmPassword"
                class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                placeholder="Re-enter password">
              @if (teamMemberForm.controls.confirmPassword.invalid && teamMemberForm.controls.confirmPassword.touched) {
                <p class="mt-1 text-sm text-red-500">
                  @if (teamMemberForm.controls.confirmPassword.errors?.['required']) {
                    Please confirm the password.
                  }
                </p>
              }
              @if (teamMemberForm.errors?.['passwordMismatch'] && (teamMemberForm.controls.password.touched || teamMemberForm.controls.confirmPassword.touched)) {
                <p class="mt-1 text-sm text-red-500">Passwords do not match.</p>
              }
            </div>
          } @else {
            <div>
              <label for="password" class="block text-sm font-medium text-slate-700 mb-2">
                New Password <span class="text-gray-400 text-xs">(optional)</span>
              </label>
              <input
                id="password"
                type="password"
                formControlName="password"
                class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                placeholder="Leave blank to keep current password">
              @if (teamMemberForm.controls.password.invalid && teamMemberForm.controls.password.touched) {
                <p class="mt-1 text-sm text-red-500">
                  @if (teamMemberForm.controls.password.errors?.['minlength']) {
                    Password must be at least 6 characters.
                  }
                </p>
              }
              <p class="mt-1 text-xs text-slate-500">Leave blank to keep the current password unchanged.</p>
            </div>
          }

          <div class="flex items-center justify-end gap-3 pt-4 border-t border-slate-200">
            <button
              type="button"
              (click)="closeModal()"
              class="px-5 py-2.5 text-sm font-medium text-slate-700 bg-slate-100 rounded-lg hover:bg-slate-200 transition">
              Cancel
            </button>
            <button
              type="submit"
              [disabled]="teamMemberForm.invalid || loading()"
              class="px-5 py-2.5 text-sm font-medium text-white bg-primary-500 rounded-lg hover:bg-primary-600 transition disabled:opacity-50 disabled:cursor-not-allowed">
              @if (loading()) {
                <i class="fa-solid fa-circle-notch animate-spin mr-2"></i>
                {{ isEditing() ? 'Updating...' : 'Creating...' }}
              } @else {
                <i class="fa-solid fa-check mr-2"></i>
                {{ isEditing() ? 'Update Team Member' : 'Create Team Member' }}
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</section>

