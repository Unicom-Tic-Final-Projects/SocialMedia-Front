<div class="max-w-7xl mx-auto">
  <div class="mb-8 flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-[#1A1A1A] mb-2">Users Management</h1>
      <p class="text-gray-600">Manage all platform users and their permissions.</p>
    </div>
    <button (click)="openCreateModal()" class="bg-[#4C6FFF] hover:bg-[#3755FF] text-white px-6 py-2 rounded-lg font-semibold transition-all hover:scale-105 shadow-md hover:shadow-lg">
      <i class="fas fa-plus mr-2"></i>Add User
    </button>
  </div>

  <!-- Users Table -->
  <div class="bg-white rounded-xl border border-[#D9E1FF] overflow-hidden shadow-sm">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-[#F5F7FF]">
          <tr>
            <th class="px-6 py-4 text-left text-sm font-semibold text-[#1A1A1A]">Name</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-[#1A1A1A]">Email</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-[#1A1A1A]">Tenant</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-[#1A1A1A]">Role</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-[#1A1A1A]">Status</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-[#1A1A1A]">Joined</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-[#1A1A1A]">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-[#D9E1FF]">
          <tr *ngIf="loading()" class="text-center">
            <td colspan="7" class="px-6 py-8 text-gray-600">
              <i class="fas fa-spinner fa-spin text-2xl mb-2 text-[#4C6FFF]"></i>
              <p>Loading users...</p>
            </td>
          </tr>
          <tr *ngIf="!loading() && users.length === 0" class="text-center">
            <td colspan="7" class="px-6 py-8 text-gray-600">
              <i class="fas fa-users text-2xl mb-2 text-gray-400"></i>
              <p>No users found</p>
            </td>
          </tr>
          <ng-container *ngIf="!loading() && users.length > 0">
            <tr *ngFor="let user of users; trackBy: trackByUserId" 
                class="hover:bg-[#F5F7FF]/50 transition-colors">
            <td class="px-6 py-4 text-[#1A1A1A] font-medium">{{ user.name }}</td>
            <td class="px-6 py-4 text-gray-600">{{ user.email }}</td>
            <td class="px-6 py-4">
              <span class="px-3 py-1 rounded-full text-xs font-semibold bg-[#BFC9FF]/30 text-[#4C6FFF]">
                {{ user.tenantName || user.tenantType }}
              </span>
            </td>
            <td class="px-6 py-4">
              <span class="px-3 py-1 rounded-full text-xs font-semibold"
                    [class.bg-[#4C6FFF]/20]="user.role?.toLowerCase().includes('admin')"
                    [class.text-[#4C6FFF]]="user.role?.toLowerCase().includes('admin')"
                    [class.bg-gray-200]="!user.role?.toLowerCase().includes('admin')"
                    [class.text-gray-600]="!user.role?.toLowerCase().includes('admin')">
                {{ user.role }}
              </span>
            </td>
            <td class="px-6 py-4">
              <span class="px-3 py-1 rounded-full text-xs font-semibold"
                    [class.bg-green-100]="user.status === 'active'"
                    [class.text-green-700]="user.status === 'active'"
                    [class.bg-red-100]="user.status === 'inactive'"
                    [class.text-red-700]="user.status === 'inactive'">
                {{ user.status }}
              </span>
            </td>
            <td class="px-6 py-4 text-gray-600">{{ user.joined }}</td>
            <td class="px-6 py-4">
              <div class="flex items-center gap-2">
                <button (click)="openEditModal(user)" class="text-[#4C6FFF] hover:text-[#3755FF] transition-colors p-2 rounded-lg hover:bg-[#BFC9FF]/30">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="text-red-600 hover:text-red-700 transition-colors p-2 rounded-lg hover:bg-red-100" (click)="deleteUser(user.id)">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- User Form Modal -->
<div *ngIf="showModal()" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" (click)="closeModal()">
  <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto" (click)="$event.stopPropagation()">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-[#1A1A1A]">{{ isEditMode() ? 'Edit User' : 'Create User' }}</h2>
        <button (click)="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <form [formGroup]="userForm" (ngSubmit)="saveUser()" class="space-y-4">
        <!-- Error Message -->
        <div *ngIf="errorMessage()" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm">
          {{ errorMessage() }}
        </div>

        <!-- Email -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
          <input type="email" formControlName="email"
                 class="w-full bg-[#F5F7FF] border border-[#D9E1FF] rounded-lg px-4 py-2 text-[#1A1A1A] focus:outline-none focus:border-[#4C6FFF] focus:ring-2 focus:ring-[#4C6FFF]/20 transition-colors"
                 [class.border-red-500]="userForm.get('email')?.invalid && userForm.get('email')?.touched">
          <p *ngIf="userForm.get('email')?.invalid && userForm.get('email')?.touched" class="text-red-600 text-xs mt-1">
            Please enter a valid email
          </p>
        </div>

        <!-- Password -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Password {{ isEditMode() ? '(leave blank to keep current)' : '*' }}
          </label>
          <input type="password" formControlName="password"
                 class="w-full bg-[#F5F7FF] border border-[#D9E1FF] rounded-lg px-4 py-2 text-[#1A1A1A] focus:outline-none focus:border-[#4C6FFF] focus:ring-2 focus:ring-[#4C6FFF]/20 transition-colors"
                 [class.border-red-500]="userForm.get('password')?.invalid && userForm.get('password')?.touched">
          <p *ngIf="userForm.get('password')?.invalid && userForm.get('password')?.touched" class="text-red-600 text-xs mt-1">
            Password must be at least 6 characters
          </p>
        </div>

        <!-- Role -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Role *</label>
          <select formControlName="role"
                  class="w-full bg-[#F5F7FF] border border-[#D9E1FF] rounded-lg px-4 py-2 text-[#1A1A1A] focus:outline-none focus:border-[#4C6FFF] focus:ring-2 focus:ring-[#4C6FFF]/20 transition-colors">
            <option value="Owner">Owner</option>
            <option value="Admin">Admin</option>
            <option value="Editor">Editor</option>
            <option value="Member">Member</option>
            <option value="Viewer">Viewer</option>
          </select>
          <p class="text-gray-500 text-xs mt-1">
            <span *ngIf="selectedTenantType() === 'Agency'">
              <strong>Recommended for Agency:</strong> Admin (full access) or Editor (content management)
            </span>
            <span *ngIf="selectedTenantType() === 'Individual'">
              <strong>Note:</strong> Owner role is typically used for individual tenants
            </span>
          </p>
        </div>

        <!-- Tenant -->
        <div>
          <div class="flex items-center justify-between mb-2">
            <label class="block text-sm font-medium text-gray-700">Tenant *</label>
            <button type="button" (click)="openTenantModal()" 
                    class="text-xs text-[#4C6FFF] hover:text-[#3755FF] font-semibold flex items-center gap-1">
              <i class="fas fa-plus text-xs"></i>
              Create Tenant
            </button>
          </div>
          <select formControlName="tenantId"
                  class="w-full bg-[#F5F7FF] border border-[#D9E1FF] rounded-lg px-4 py-2 text-[#1A1A1A] focus:outline-none focus:border-[#4C6FFF] focus:ring-2 focus:ring-[#4C6FFF]/20 transition-colors"
                  [class.border-red-500]="userForm.get('tenantId')?.invalid && userForm.get('tenantId')?.touched">
            <option value="">Select Tenant</option>
            <optgroup *ngFor="let group of tenantGroups()" [label]="group.type">
              <option *ngFor="let tenant of group.tenants" [value]="tenant.tenantId">
                {{ tenant.name }}
              </option>
            </optgroup>
          </select>
          <p *ngIf="userForm.get('tenantId')?.invalid && userForm.get('tenantId')?.touched" class="text-red-600 text-xs mt-1">
            Please select a tenant
          </p>
          <!-- Show info for Agency tenants -->
          <div *ngIf="selectedTenantType() === 'Agency'" class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-xs text-blue-800">
              <i class="fas fa-info-circle mr-1"></i>
              <strong>Agency Tenant:</strong> You can create multiple users (Admin, Editor, Member, Viewer) for this agency.
            </p>
          </div>
          <div *ngIf="selectedTenantType() === 'Individual'" class="mt-2 p-3 bg-gray-50 border border-gray-200 rounded-lg">
            <p class="text-xs text-gray-700">
              <i class="fas fa-user mr-1"></i>
              <strong>Individual Tenant:</strong> Typically has one owner user. Additional users can be added if needed.
            </p>
          </div>
        </div>

        <!-- Active Status -->
        <div class="flex items-center gap-3">
          <input type="checkbox" formControlName="isActive" id="isActive"
                 class="w-4 h-4 text-[#4C6FFF] bg-gray-100 border-gray-300 rounded focus:ring-[#4C6FFF] focus:ring-2">
          <label for="isActive" class="text-sm font-medium text-gray-700">Active</label>
        </div>

        <!-- Actions -->
        <div class="flex gap-3 pt-4">
          <button type="button" (click)="closeModal()"
                  class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold transition-colors">
            Cancel
          </button>
          <button type="submit" [disabled]="saving() || userForm.invalid"
                  class="flex-1 bg-[#4C6FFF] hover:bg-[#3755FF] disabled:opacity-50 disabled:cursor-not-allowed text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-md hover:shadow-lg">
            <i *ngIf="saving()" class="fas fa-spinner fa-spin mr-2"></i>
            {{ saving() ? 'Saving...' : (isEditMode() ? 'Update' : 'Create') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Tenant Form Modal -->
<div *ngIf="showTenantModal()" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" (click)="closeTenantModal()">
  <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto" (click)="$event.stopPropagation()">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-[#1A1A1A]">Create Tenant</h2>
        <button (click)="closeTenantModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <form [formGroup]="tenantForm" (ngSubmit)="saveTenant()" class="space-y-4">
        <!-- Success Message -->
        <div *ngIf="tenantCreatedSuccessfully()" 
             class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg text-sm">
          <i class="fas fa-check-circle mr-2"></i>
          <strong>Tenant "{{ tenantForm.get('displayName')?.value || tenantForm.get('email')?.value }}" created/reactivated successfully!</strong>
          <span *ngIf="tenantForm.get('email')?.value" class="block mt-1">
            Owner user "{{ tenantForm.get('email')?.value }}" has been created/reactivated. Login credentials have been sent via email.
          </span>
        </div>
        <!-- Error Message -->
        <div *ngIf="errorMessage()" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm">
          <i class="fas fa-exclamation-circle mr-2"></i>
          {{ errorMessage() }}
        </div>

        <!-- Email Address -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
          <input type="email" formControlName="email"
                 class="w-full bg-[#F5F7FF] border border-[#D9E1FF] rounded-lg px-4 py-2 text-[#1A1A1A] focus:outline-none focus:border-[#4C6FFF] focus:ring-2 focus:ring-[#4C6FFF]/20 transition-colors"
                 [class.border-red-500]="(tenantForm.get('email')?.invalid && tenantForm.get('email')?.touched) || emailExists()"
                 placeholder="you@example.com">
          <p *ngIf="tenantForm.get('email')?.invalid && tenantForm.get('email')?.touched && !emailExists()" class="text-red-600 text-xs mt-1">
            <span *ngIf="tenantForm.get('email')?.errors?.['required']">Email is required</span>
            <span *ngIf="tenantForm.get('email')?.errors?.['email'] && !tenantForm.get('email')?.errors?.['required']">Please enter a valid email</span>
          </p>
          <p *ngIf="emailExists()" class="text-red-600 text-xs mt-1">
            <i class="fas fa-exclamation-circle mr-1"></i>
            A user with this email already exists. Please use a different email address.
          </p>
          <p *ngIf="!emailExists() && tenantForm.get('email')?.valid && tenantForm.get('email')?.touched" class="text-green-600 text-xs mt-1">
            <i class="fas fa-check-circle mr-1"></i>
            This email is available.
          </p>
          <p class="text-gray-500 text-xs mt-1" *ngIf="!tenantForm.get('email')?.touched || !tenantForm.get('email')?.value">
            This email will be used as the tenant name and owner email address.
          </p>
        </div>

        <!-- Display Name -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
          <input type="text" formControlName="displayName"
                 class="w-full bg-[#F5F7FF] border border-[#D9E1FF] rounded-lg px-4 py-2 text-[#1A1A1A] focus:outline-none focus:border-[#4C6FFF] focus:ring-2 focus:ring-[#4C6FFF]/20 transition-colors"
                 placeholder="My Account">
          <p class="text-gray-500 text-xs mt-1">
            Optional display name for the tenant. If empty, the email prefix will be used.
          </p>
        </div>

        <!-- Account Type -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Account Type *</label>
          <div class="grid grid-cols-2 gap-3">
            <!-- Individual -->
            <label class="flex flex-col items-start gap-2 px-4 py-3 rounded-lg border transition cursor-pointer"
                   [class.border-[#4C6FFF]]="tenantForm.get('tenantType')?.value === 'Individual'"
                   [class.bg-[#BFC9FF]/30]="tenantForm.get('tenantType')?.value === 'Individual'"
                   [class.border-[#D9E1FF]]="tenantForm.get('tenantType')?.value !== 'Individual'">
              <input type="radio" class="hidden" value="Individual" formControlName="tenantType">
              <span class="text-sm font-semibold text-[#1A1A1A]">Individual</span>
              <span class="text-xs text-[#222222]/70">For solo creators managing their own channels.</span>
            </label>

            <!-- Agency -->
            <label class="flex flex-col items-start gap-2 px-4 py-3 rounded-lg border transition cursor-pointer"
                   [class.border-[#4C6FFF]]="tenantForm.get('tenantType')?.value === 'Agency'"
                   [class.bg-[#BFC9FF]/30]="tenantForm.get('tenantType')?.value === 'Agency'"
                   [class.border-[#D9E1FF]]="tenantForm.get('tenantType')?.value !== 'Agency'">
              <input type="radio" class="hidden" value="Agency" formControlName="tenantType">
              <span class="text-sm font-semibold text-[#1A1A1A]">Agency</span>
              <span class="text-xs text-[#222222]/70">For marketing teams managing multiple clients.</span>
            </label>
          </div>
        </div>

        <!-- Password -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Password *</label>
          <input type="password" formControlName="password"
                 class="w-full bg-[#F5F7FF] border border-[#D9E1FF] rounded-lg px-4 py-2 text-[#1A1A1A] focus:outline-none focus:border-[#4C6FFF] focus:ring-2 focus:ring-[#4C6FFF]/20 transition-colors"
                 [class.border-red-500]="tenantForm.get('password')?.invalid && tenantForm.get('password')?.touched"
                 placeholder="At least 6 characters">
          <p *ngIf="tenantForm.get('password')?.invalid && tenantForm.get('password')?.touched" class="text-red-600 text-xs mt-1">
            <span *ngIf="tenantForm.get('password')?.errors?.['required']">Password is required</span>
            <span *ngIf="tenantForm.get('password')?.errors?.['minlength'] && !tenantForm.get('password')?.errors?.['required']">Password must be at least 6 characters</span>
          </p>
          <p class="text-gray-500 text-xs mt-1">
            Password for the owner account. Login credentials will be sent via email.
          </p>
        </div>

        <!-- Actions -->
        <div class="flex gap-3 pt-4">
          <button type="button" (click)="closeTenantModal()"
                  class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold transition-colors">
            Cancel
          </button>
          <button type="submit" [disabled]="savingTenant() || tenantForm.invalid"
                  class="flex-1 bg-[#4C6FFF] hover:bg-[#3755FF] disabled:opacity-50 disabled:cursor-not-allowed text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-md hover:shadow-lg">
            <i *ngIf="savingTenant()" class="fas fa-spinner fa-spin mr-2"></i>
            {{ savingTenant() ? 'Creating...' : 'Create Tenant' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

