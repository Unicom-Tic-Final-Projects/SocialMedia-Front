<div
  *ngIf="open"
  class="fixed inset-0 z-50 flex items-center justify-center 
         bg-black/40 backdrop-blur-md px-4"
  (click)="closeModal()"
>
  <div
    class="bg-[#FFFFFF] rounded-2xl shadow-2xl w-full max-w-6xl 
           max-h-[90vh] overflow-hidden border border-[#BFC9FF]"
    (click)="$event.stopPropagation()"
  >
    <!-- HEADER -->
    <div
      class="flex items-center justify-between px-6 py-4 
             border-b border-[#DDE3FF]"
    >
      <h2 class="text-2xl font-extrabold text-[#1A1A1A] flex items-center gap-2">
        <i class="fa-solid fa-crop-simple text-[#4C6FFF]"></i>
        Crop & Preview
      </h2>

      <button
        (click)="closeModal()"
        class="text-[#4C6FFF] hover:text-[#1A1A1A] transition p-2 
               rounded-lg hover:bg-[#BFC9FF]/30"
      >
        <i class="fa-solid fa-times text-xl"></i>
      </button>
    </div>

    <!-- MAIN CONTENT -->
    <div class="flex flex-col lg:flex-row h-[calc(90vh-70px)]">

      <!-- LEFT PANEL (platforms) -->
      <div
        class="lg:w-64 border-r border-[#DDE3FF] bg-[#F9FAFF] overflow-y-auto"
      >
        <div class="p-4">
          <h3
            class="text-xs font-bold uppercase tracking-wide 
                   text-[#222222]/60 mb-3"
          >
            Platforms
          </h3>

          <div class="space-y-2">
            <button
              *ngFor="let p of targets"
              (click)="selectPlatform(p)"
              class="w-full flex items-center gap-3 px-4 py-3 rounded-lg border
                     transition text-left font-medium"
              [class.bg-[#4C6FFF]]="selectedPlatform === p"
              [class.text-white]="selectedPlatform === p"
              [class.border-[#4C6FFF]]="selectedPlatform === p"
              [class.text-[#1A1A1A]]="selectedPlatform !== p"
              [class.bg-white]="selectedPlatform !== p"
              [class.border-[#DDE3FF]]="selectedPlatform !== p"
            >
              <i [class]="getPlatformIcon(p) + ' text-lg'"></i>
              {{ getPlatformName(p) }}
            </button>
          </div>
        </div>
      </div>

      <!-- MIDDLE: MAIN IMAGE AREA -->
      <div
        class="flex-1 flex items-center justify-center bg-[#F4F6FF] 
               border-r border-[#DDE3FF] px-4 relative"
        (mousemove)="moveImage($event)"
        (mouseup)="stopImageDrag()"
        (touchmove)="moveImage($event)"
        (touchend)="stopImageDrag()"
      >
        <div class="text-center mb-6">
          <p class="text-sm text-[#222222]/80">Aspect Ratio</p>
          <p class="text-xl font-bold text-[#4C6FFF]">
            {{ platformAspects.get(selectedPlatform)?.label }}
          </p>
        </div>

        <div
          class="relative overflow-hidden shadow-xl rounded-xl border
                 border-[#DDE3FF] bg-white"
          [style.width.px]="getDisplayDimensions(selectedPlatform).width"
          [style.height.px]="getDisplayDimensions(selectedPlatform).height"
        >
          <!-- IMAGE -->
          <img
            *ngIf="mediaUrl"
            [src]="mediaUrl"
            class="w-full h-full object-cover"
            [ngStyle]="imageStyle(selectedPlatform)"
            (mousedown)="startImageDrag($event)"
            (touchstart)="startImageDrag($event)"
            (load)="onImageLoad()"
          />

          <!-- FREE-FORM CROPBOX -->
          <div
            class="absolute border-2 rounded-lg border-[#4C6FFF] 
                   backdrop-blur-sm bg-[#4C6FFF]/10"
            [style.width.px]="cropBox.width"
            [style.height.px]="cropBox.height"
            [style.left.px]="cropBox.left"
            [style.top.px]="cropBox.top"
          >
            <!-- HANDLES -->
            <div
              class="absolute w-3 h-3 bg-white border border-[#4C6FFF] 
                     -top-1/2 left-1/2 transform -translate-x-1/2 rounded-full cursor-n-resize"
              (mousedown)="startResize($event, 't')"
            ></div>

            <div
              class="absolute w-3 h-3 bg-white border border-[#4C6FFF] 
                     -bottom-1/2 left-1/2 transform -translate-x-1/2 rounded-full cursor-s-resize"
              (mousedown)="startResize($event, 'b')"
            ></div>

            <div
              class="absolute w-3 h-3 bg-white border border-[#4C6FFF] 
                     -left-1/2 top-1/2 transform -translate-y-1/2 rounded-full cursor-e-resize"
              (mousedown)="startResize($event, 'l')"
            ></div>

            <div
              class="absolute w-3 h-3 bg-white border border-[#4C6FFF] 
                     -right-1/2 top-1/2 transform -translate-y-1/2 rounded-full cursor-w-resize"
              (mousedown)="startResize($event, 'r')"
            ></div>

            <!-- CORNER -->
            <div
              class="absolute w-4 h-4 bg-white border border-[#4C6FFF] 
                     -right-2 -bottom-2 rounded-md cursor-se-resize"
              (mousedown)="startResize($event, 'br')"
            ></div>
          </div>
        </div>
      </div>

      <!-- RIGHT PANEL: DETAILS -->
      <div class="lg:w-1/3 p-6 bg-[#FFFFFF] overflow-y-auto">
        <h3 class="text-lg font-bold text-[#1A1A1A] mb-4">Post Details</h3>

        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-[#222222]/60">Platform:</span>
            <span class="text-[#1A1A1A] font-semibold">{{ getPlatformName(selectedPlatform) }}</span>
          </div>

          <div class="flex justify-between">
            <span class="text-[#222222]/60">Aspect Ratio:</span>
            <span class="text-[#4C6FFF] font-semibold">
              {{ platformAspects.get(selectedPlatform)?.label }}
            </span>
          </div>

          <div class="flex justify-between">
            <span class="text-[#222222]/60">Dimensions:</span>
            <span class="text-[#1A1A1A] font-semibold">
              {{ platformAspects.get(selectedPlatform)?.width }} Ã—
              {{ platformAspects.get(selectedPlatform)?.height }}
            </span>
          </div>
        </div>

        <!-- CAPTION -->
        <div class="mt-6">
          <h4 class="text-sm font-semibold text-[#1A1A1A] mb-2">Caption</h4>

          <div
            class="bg-[#F4F6FF] border border-[#DDE3FF] rounded-xl p-4 text-[#222222]"
          >
            <div *ngIf="caption; else emptyCap">
              {{ caption }}
            </div>

            <ng-template #emptyCap>
              <p class="text-[#222222]/50 italic">No caption provided.</p>
            </ng-template>
          </div>
        </div>

        <button
          class="mt-6 w-full bg-[#4C6FFF] text-white font-semibold py-3 rounded-xl 
                 shadow-md hover:bg-[#3A59DD] transition"
        >
          Done
        </button>
      </div>
    </div>
  </div>
</div>
